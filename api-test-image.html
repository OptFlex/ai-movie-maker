<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIç”»åƒç”Ÿæˆãƒ†ã‚¹ãƒˆ - nanobanana Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">AIç”»åƒç”Ÿæˆãƒ†ã‚¹ãƒˆ</h1>
            <p class="text-gray-600 mt-2">Nano Banana Proï¼ˆGemini 3 Pro Imageï¼‰ã§ç”»åƒç”Ÿæˆ</p>
        </header>

        <div class="max-w-3xl mx-auto">

            <!-- nanobanana Pro - ç”»åƒç”Ÿæˆ -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-purple-700">ğŸ–¼ï¸ nanobanana Pro</h2>
                    <span class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full">ç”»åƒç”Ÿæˆ</span>
                </div>

                <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ› -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label>
                    <textarea
                        id="nanobanana-prompt"
                        class="w-full h-32 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                        placeholder="ä¾‹: æœªæ¥çš„ãªéƒ½å¸‚ã®é¢¨æ™¯ã€ãƒã‚ªãƒ³ãƒ©ã‚¤ãƒˆã€ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ã€8kã€é«˜å“è³ª"
                    ></textarea>
                </div>

                <!-- è¨­å®š -->
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">ç”Ÿæˆæšæ•°</label>
                        <select id="nanobanana-count" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="1">1æš</option>
                            <option value="2">2æš</option>
                            <option value="4" selected>4æš</option>
                            <option value="8">8æš</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">ç”»è³ª</label>
                        <select id="nanobanana-quality" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="standard">æ¨™æº–</option>
                            <option value="hd" selected>HD</option>
                            <option value="uhd">UHD</option>
                        </select>
                    </div>
                </div>

                <!-- ç”Ÿæˆãƒœã‚¿ãƒ³ -->
                <button
                    onclick="generateImages()"
                    class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-pink-700 transition mb-4"
                >
                    ç”»åƒã‚’ç”Ÿæˆã™ã‚‹
                </button>

                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                <div id="nanobanana-status" class="mb-4 hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center gap-3">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                        <span class="text-sm text-blue-700">ç”»åƒã‚’ç”Ÿæˆä¸­...</span>
                    </div>
                </div>

                <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="border-t border-gray-200 pt-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">ç”Ÿæˆçµæœ</h3>
                    <div id="nanobanana-results" class="grid grid-cols-2 gap-3 min-h-[200px]">
                        <div class="aspect-video bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 text-sm">
                            ç”»åƒ1
                        </div>
                        <div class="aspect-video bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 text-sm">
                            ç”»åƒ2
                        </div>
                        <div class="aspect-video bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 text-sm">
                            ç”»åƒ3
                        </div>
                        <div class="aspect-video bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 text-sm">
                            ç”»åƒ4
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Edge FunctionsçµŒç”±ã§å®‰å…¨ã«å®Ÿè¡Œ -->
        <div class="mt-8 bg-green-50 border border-green-200 rounded-lg p-4 max-w-3xl mx-auto">
            <h3 class="text-sm font-bold text-green-800 mb-2">ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
            <p class="text-xs text-green-700">
                APIã‚­ãƒ¼ã¯Supabase Edge Functionsã§å®‰å…¨ã«ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
                ãƒ–ãƒ©ã‚¦ã‚¶ã«APIã‚­ãƒ¼ã¯ä¸€åˆ‡éœ²å‡ºã—ã¾ã›ã‚“ã€‚
            </p>
        </div>

    </div>

    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://sdrpysyhoqnrpixwnhfy.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkcnB5c3lob3FucnBpeHduaGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2ODYwMDMsImV4cCI6MjA4MzI2MjAwM30.UK9f1aP_49c49KlIHRekvb3nmK5pInR3kMW-mwILzkI'

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession()

            if (!session) {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰login.htmlã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = './login.html'
                return
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«èªè¨¼ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        checkAuth()

        // ç”Ÿæˆã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        let generatedImages = [];

        // nanobanana Pro - ç”»åƒç”Ÿæˆï¼ˆEdge FunctionsçµŒç”±ï¼‰
        async function generateImages() {
            const prompt = document.getElementById('nanobanana-prompt').value;
            const count = parseInt(document.getElementById('nanobanana-count').value);
            const quality = document.getElementById('nanobanana-quality').value;

            if (!prompt) {
                alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            document.getElementById('nanobanana-status').classList.remove('hidden');
            document.getElementById('nanobanana-results').innerHTML = '<div class="col-span-2 text-center text-gray-500">ç”Ÿæˆä¸­...</div>';

            console.log('Edge FunctionçµŒç”±ã§ç”»åƒç”Ÿæˆ:', { prompt, count, quality });

            try {
                // Edge Function URL
                const edgeFunctionUrl = `${SUPABASE_URL}/functions/v1/generate-image`

                // è¤‡æ•°ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ã€countå›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹
                const promises = [];
                for (let i = 0; i < count; i++) {
                    promises.push(
                        fetch(edgeFunctionUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_ANON_KEY
                            },
                            body: JSON.stringify({ prompt })
                        })
                    );
                }

                const responses = await Promise.all(promises);

                // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                generatedImages = [];

                // çµæœè¡¨ç¤º
                document.getElementById('nanobanana-status').classList.add('hidden');
                const resultsDiv = document.getElementById('nanobanana-results');
                resultsDiv.innerHTML = '';

                let successCount = 0;

                for (let i = 0; i < responses.length; i++) {
                    const response = responses[i];

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error(`Image ${i + 1} Error:`, errorData);
                        continue;
                    }

                    const data = await response.json();
                    console.log(`API Response ${i + 1}:`, data);

                    // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
                    if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                        for (const part of data.candidates[0].content.parts) {
                            if (part.inlineData && part.inlineData.data) {
                                const imageData = part.inlineData.data;
                                generatedImages.push(imageData);

                                resultsDiv.innerHTML += `
                                    <div class="relative group cursor-pointer">
                                        <img id="nanobanana-img-${successCount}" src="data:image/png;base64,${imageData}" class="aspect-video rounded-lg object-cover" alt="ç”Ÿæˆç”»åƒ ${successCount + 1}">
                                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition rounded-lg flex items-center justify-center">
                                            <button onclick="downloadImage(${successCount})" class="opacity-0 group-hover:opacity-100 px-3 py-1 bg-white text-gray-800 rounded-lg text-xs font-semibold hover:bg-gray-100">
                                                ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                            </button>
                                        </div>
                                    </div>
                                `;
                                successCount++;
                            }
                        }
                    }
                }

                if (successCount === 0) {
                    resultsDiv.innerHTML = '<div class="col-span-2 text-center text-red-500">ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('nanobanana-status').classList.add('hidden');
                document.getElementById('nanobanana-results').innerHTML = `
                    <div class="col-span-2 text-center text-red-500">
                        ã‚¨ãƒ©ãƒ¼: ${error.message}
                    </div>
                `;
            }
        }

        // ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function downloadImage(index) {
            if (generatedImages[index]) {
                // å®Ÿéš›ã®APIçµŒç”±ã§å–å¾—ã—ãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                const base64Data = generatedImages[index];
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'image/png' });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nanobanana-image-${index + 1}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                console.log(`ç”»åƒ ${index + 1} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
            } else {
                alert('ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
            }
        }
    </script>
</body>
</html>
