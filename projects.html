<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ç”»ä¸€è¦§ - AI Movie Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="bg-white border-b border-gray-200 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <a href="./index.html" class="text-gray-600 hover:text-gray-900 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </a>
                    <div class="text-3xl">ğŸ“‹</div>
                    <h1 class="text-2xl font-bold text-gray-900">çµµã‚³ãƒ³ãƒ†ä¼ç”»ä¸€è¦§</h1>
                </div>
                <div class="flex items-center gap-4">
                    <span id="user-email" class="text-sm text-gray-600">user@example.com</span>
                    <button id="logout-btn" class="text-sm text-red-600 hover:text-red-700 font-medium transition">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="flex-1 max-w-7xl mx-auto px-4 py-8 w-full">
            <!-- æ–°è¦ä¼ç”»ä½œæˆãƒœã‚¿ãƒ³ -->
            <div class="mb-8">
                <button id="create-project-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold flex items-center gap-2 shadow-md hover:shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    æ–°è¦ä¼ç”»ä½œæˆ
                </button>
            </div>

            <!-- ä¼ç”»ä¸€è¦§ -->
            <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>

            <!-- ä¼ç”»ãŒãªã„å ´åˆã®è¡¨ç¤º -->
            <div id="empty-state" class="hidden text-center py-20">
                <div class="text-6xl mb-4">ğŸ“‹</div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">ä¼ç”»ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</h3>
                <p class="text-gray-600 mb-6">ã€Œæ–°è¦ä¼ç”»ä½œæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰æœ€åˆã®ä¼ç”»ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
            </div>
        </main>
    </div>

    <!-- æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="create-project-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">æ–°è¦ä¼ç”»ä½œæˆ</h2>

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">ä¼ç”»ã‚¿ã‚¤ãƒˆãƒ« *</label>
                <input
                    type="text"
                    id="new-project-title"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="ä¾‹: YouTubeå‹•ç”»ä¼ç”» #1"
                    required
                />
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">ãƒãƒ£ãƒ³ãƒãƒ«å</label>
                <input
                    type="text"
                    id="new-project-channel"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="ä¾‹: Techè§£èª¬ãƒãƒ£ãƒ³ãƒãƒ«"
                />
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">èª¬æ˜</label>
                <textarea
                    id="new-project-description"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                    rows="3"
                    placeholder="ä¼ç”»ã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰"
                ></textarea>
            </div>

            <div class="flex gap-3">
                <button
                    id="cancel-create-btn"
                    class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold"
                >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                    id="confirm-create-btn"
                    class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold"
                >
                    ä½œæˆ
                </button>
            </div>
        </div>
    </div>

    <!-- å…±é€šèªè¨¼ãƒã‚§ãƒƒã‚¯ -->
    <script src="./auth.js"></script>

    <script>

        // ========================================
        // ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
        // ========================================
        async function loadProjects() {
            const { data, error } = await supabaseClient
                .from('projects')
                .select('*')
                .order('updated_at', { ascending: false});

            if (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }

            return data || [];
        }

        // ========================================
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆé–¢æ•°
        // ========================================
        async function createProject(title, channelName, description) {
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (!session) {
                throw new Error('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
            }

            const { data, error } = await supabaseClient
                .from('projects')
                .insert([
                    {
                        user_id: session.user.id,
                        title: title,
                        channel_name: channelName || null,
                        description: description || null,
                        thumbnail_url: null
                    }
                ])
                .select()
                .single();

            if (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }

            return data;
        }

        // ========================================
        // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        // ========================================
        function openCreateModal() {
            document.getElementById('create-project-modal').classList.remove('hidden');
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('new-project-title').value = '';
            document.getElementById('new-project-channel').value = '';
            document.getElementById('new-project-description').value = '';
        }

        function closeCreateModal() {
            document.getElementById('create-project-modal').classList.add('hidden');
        }

        // ========================================
        // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        // ========================================
        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        // ========================================
        // ä¼ç”»ä¸€è¦§ã‚’æç”»
        // ========================================
        function renderProjects(projects) {
            const listDiv = document.getElementById('projects-list');
            const emptyState = document.getElementById('empty-state');

            if (projects.length === 0) {
                listDiv.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            listDiv.classList.remove('hidden');
            emptyState.classList.add('hidden');

            // ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‹•çš„ã«HTMLã‚’ç”Ÿæˆ
            const html = projects.map(project => `
                <div class="cursor-pointer group bg-white border-2 border-gray-200 rounded-xl p-3 shadow-md hover:shadow-xl hover:border-blue-400 transition-all"
                     onclick="openProject('${project.id}')">
                    <!-- ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ -->
                    <div class="aspect-video rounded-lg mb-3 flex items-center justify-center overflow-hidden ${project.thumbnail_url ? '' : 'bg-gray-200 border-2 border-gray-300'}">
                        ${project.thumbnail_url
                            ? `<img src="${project.thumbnail_url}" class="w-full h-full object-cover" alt="ã‚µãƒ ãƒã‚¤ãƒ«">`
                            : '<span class="text-gray-400 text-4xl">ğŸ“‹</span>'
                        }
                    </div>
                    <!-- ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æƒ…å ± -->
                    <div>
                        <h3 class="font-semibold text-gray-900 group-hover:text-blue-600 transition line-clamp-2 text-sm mb-2">
                            ${project.title}
                        </h3>
                        <p class="text-xs text-gray-600">${project.channel_name || 'æœªè¨­å®š'}</p>
                        <p class="text-xs text-gray-500">${formatDate(project.updated_at)} æ›´æ–°</p>
                    </div>
                </div>
            `).join('');

            listDiv.innerHTML = html;
        }

        // ========================================
        // ä¼ç”»ã‚’é–‹ã
        // ========================================
        function openProject(projectId) {
            console.log('ä¼ç”»ã‚’é–‹ã: ID =', projectId);
            window.location.href = `./storyboard.html?project=${projectId}`;
        }

        // ========================================
        // åˆæœŸåŒ–å‡¦ç†
        // ========================================
        async function init() {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯ã¨ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆç¢ºèª
            const session = await checkAuthAndWhitelist()

            if (!session) {
                return // èªè¨¼å¤±æ•—æ™‚ã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ¸ˆã¿
            }

            // èªè¨¼OK - ç”»é¢ã‚’è¡¨ç¤º
            document.getElementById('app').style.display = 'flex';

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('user-email').textContent = session.user.email || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';

            // ä¼ç”»ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
            try {
                const projects = await loadProjects();
                renderProjects(projects);
            } catch (error) {
                console.error('ä¼ç”»ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                alert('ä¼ç”»ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ========================================
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // ========================================

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
        document.getElementById('logout-btn').addEventListener('click', async () => {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                await logout()
            }
        });

        // æ–°è¦ä¼ç”»ä½œæˆãƒœã‚¿ãƒ³
        document.getElementById('create-project-btn').addEventListener('click', () => {
            openCreateModal();
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ« - ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
        document.getElementById('cancel-create-btn').addEventListener('click', () => {
            closeCreateModal();
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ« - ä½œæˆãƒœã‚¿ãƒ³
        document.getElementById('confirm-create-btn').addEventListener('click', async () => {
            const title = document.getElementById('new-project-title').value.trim();
            const channelName = document.getElementById('new-project-channel').value.trim();
            const description = document.getElementById('new-project-description').value.trim();

            if (!title) {
                alert('ä¼ç”»ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
                const newProject = await createProject(title, channelName, description);
                console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæˆåŠŸ:', newProject);

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                closeCreateModal();

                // storyboard.htmlã¸é·ç§»
                window.location.href = `./storyboard.html?project=${newProject.id}`;
            } catch (error) {
                console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
